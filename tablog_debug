#!/home/utils/Python/builds/3.11.9-20250715/bin/python3
"""
TabLog Launcher Script - DEBUG VERSION
Shows environment setup for troubleshooting
"""

import os
import sys
import subprocess
from pathlib import Path

script_dir = Path(__file__).parent.resolve()
python_exe = f"{script_dir}/venv_pyqt5_rebuild/bin/python3"
qt_plugin_path = f"{script_dir}/venv_pyqt5_rebuild/lib/python3.11/site-packages/PyQt5/Qt5/plugins"
qt_lib_path = f"{script_dir}/venv_pyqt5_rebuild/lib/python3.11/site-packages/PyQt5/Qt5/lib"

print("=" * 80)
print("TabLog DEBUG Launcher")
print("=" * 80)
print()

print("BEFORE environment setup:")
print(f"LD_LIBRARY_PATH = {os.environ.get('LD_LIBRARY_PATH', '(not set)')}")
print()

# Setup environment
os.environ['PYTHONPATH'] = f"{python_exe}:{script_dir}"
os.environ['QT_PLUGIN_PATH'] = qt_plugin_path

system_lib_path = "/lib64"
current_ld_path = os.environ.get('LD_LIBRARY_PATH', '')

# Build new path - join as strings to preserve colon-separated directories
if current_ld_path:
    new_ld_path = f"{qt_lib_path}:{system_lib_path}:{current_ld_path}"
else:
    new_ld_path = f"{qt_lib_path}:{system_lib_path}"

os.environ['LD_LIBRARY_PATH'] = new_ld_path

# For display purposes, split into list
new_ld_path_parts = new_ld_path.split(':')

user = os.environ.get('USER', 'user')
os.environ['XDG_RUNTIME_DIR'] = f'/tmp/runtime-{user}'
os.environ.setdefault('QT_LOGGING_RULES', '*=false')
os.environ['PYTHONWARNINGS'] = 'ignore::DeprecationWarning'

print("AFTER environment setup:")
print(f"LD_LIBRARY_PATH = {os.environ['LD_LIBRARY_PATH']}")
print()
print("Library search order:")
for i, path in enumerate(new_ld_path_parts, 1):
    exists = "✅" if os.path.isdir(path) else "❌"
    print(f"  {i}. {exists} {path}")
print()

print("Checking for FreeType libraries:")
freetype_found = False
for path in new_ld_path_parts:
    if os.path.isdir(path):
        try:
            freetype_files = [f for f in os.listdir(path) if 'libfreetype' in f]
            if freetype_files:
                freetype_found = True
                print(f"  Found in {path}:")
                for f in freetype_files:
                    print(f"    - {f}")
        except PermissionError:
            pass  # Skip directories we can't read
if not freetype_found:
    print("  (No FreeType libraries found in LD_LIBRARY_PATH directories)")
print()

print("=" * 80)
print("Launching TabLog...")
print("=" * 80)
print()

# Launch
logviewtab_script = script_dir / "LogViewTab.py"
result = subprocess.run(
    [python_exe, str(logviewtab_script)] + sys.argv[1:],
    env=os.environ.copy()
)
sys.exit(result.returncode)

